<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cluj Bus Live PRO</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #4CAF50;
            --bg: #0a0a0a;
            --panel-bg: rgba(26, 26, 26, 0.95);
        }

        body { margin: 0; background: var(--bg); font-family: -apple-system, sans-serif; color: white; overflow: hidden; }
        
        #map { height: 100vh; width: 100vw; }

        /* Panel Sosiri */
        #arrivals-panel { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: var(--panel-bg); 
            backdrop-filter: blur(10px);
            padding: 25px; 
            border-radius: 25px 25px 0 0; 
            transform: translateY(100%); 
            transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1); 
            z-index: 1000; 
            border-top: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 -10px 25px rgba(0,0,0,0.5);
            max-height: 70vh;
            overflow-y: auto;
        }

        #arrivals-panel.active { transform: translateY(0); }

        .handle { width: 40px; height: 5px; background: #444; border-radius: 10px; margin: -10px auto 15px; }

        .header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        
        h2 { margin: 0; font-size: 22px; color: var(--primary); }

        .close-btn { background: #333; border: none; color: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; }

        /* Lista Bus */
        .bus-item { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 18px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .bus-info { display: flex; align-items: center; gap: 15px; }
        
        .bus-badge { 
            background: #e31e24; color: white; 
            min-width: 45px; height: 35px; 
            display: flex; align-items: center; justify-content: center;
            border-radius: 8px; font-weight: 800; font-size: 18px;
        }

        .bus-time { color: var(--primary); font-weight: 700; font-size: 22px; }
        .bus-unit { font-size: 12px; color: #888; margin-left: 4px; }

        /* Status Messages */
        .loader { text-align: center; padding: 40px; color: #888; }
        .error-msg { color: #ff9800; text-align: center; padding: 20px; font-weight: 500; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="arrivals-panel">
    <div class="handle"></div>
    <div class="header">
        <div>
            <h2 id="st-name">Stație</h2>
            <div id="st-id" style="font-size: 12px; color: #666;">ID Stație</div>
        </div>
        <button class="close-btn" onclick="togglePanel(false)">&times;</button>
    </div>
    <div id="list-container"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. Configurare Hartă
    const map = L.map('map', { zoomControl: false }).setView([46.76, 23.55], 13);
    
    // Satelit Dark de la ArcGIS
    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);

    // 2. Stații
   const stations = [
    // CLUJ-NAPOCA
    {id: "148", n: "Sora (Centru)", lat: 46.771960, lng: 23.589531},
    {id: "143", n: "Memorandumului Sud", lat: 46.769255, lng: 23.585220},
    {id: "350", n: "Gara Mică", lat: 46.784520, lng: 23.586610},
    {id: "24", n: "Minerva (Mănăștur)", lat: 46.758650, lng: 23.546120},
    {id: "481", n: "Vivo (Polus)", lat: 46.751430, lng: 23.527810},
    
    // FLOREȘTI
    {id: "512", n: "Florești Primărie", lat: 46.745422, lng: 23.483251},
    {id: "510", n: "Oncos Florești", lat: 46.748350, lng: 23.501180},
    {id: "515", n: "Luna de Sus", lat: 46.741210, lng: 23.442310},
    {id: "570", n: "Stejarului (Florești)", lat: 46.751120, lng: 23.512450}
];
    // 3. Adăugare Marcaje
    stations.forEach(s => {
        L.circleMarker([s.lat, s.lng], {
            radius: 12, fillColor: '#4CAF50', color: '#fff', weight: 3, fillOpacity: 1
        }).addTo(map).on('click', () => fetchArrivals(s));
    });

    // 4. Funcția de Fetch (folosește folderul /api)
    async function fetchArrivals(s) {
        const panel = document.getElementById('arrivals-panel');
        const list = document.getElementById('list-container');
        
        document.getElementById('st-name').innerText = s.n;
        document.getElementById('st-id').innerText = `ID: ${s.id}`;
        
        panel.classList.add('active');
        list.innerHTML = '<div class="loader">Se caută autobuze live...</div>';

        try {
            const res = await fetch(`/api/arrivals?id=${s.id}`);
            const data = await res.json();

            // Gestionare Erori (inclusiv 502 de la Tranzy)
            if (!res.ok || data.error) {
                list.innerHTML = `<div class="error-msg">⚠️ Serverul Tranzy (OpenData) nu răspunde acum. Probabil este în mentenanță de noapte. Reîncearcă după ora 05:00.</div>`;
                return;
            }

            if (!Array.isArray(data) || data.length === 0) {
                list.innerHTML = '<div class="loader">Nu s-au găsit autobuze active pentru această stație în următoarele 30 de minute.</div>';
                return;
            }

            // Generare listă sosiri
            list.innerHTML = data.map(bus => `
                <div class="bus-item">
                    <div class="bus-info">
                        <div class="bus-badge">${bus.routeShortName}</div>
                        <div style="font-size: 14px;">Spre capăt de linie</div>
                    </div>
                    <div class="bus-time">
                        ${Math.round(bus.arrivalMinutes)}<span class="bus-unit">min</span>
                    </div>
                </div>
            `).join('');

        } catch (err) {
            list.innerHTML = '<div class="error-msg">Eroare de conexiune. Verifică dacă folderul /api este configurat corect pe Vercel.</div>';
        }
    }

    function togglePanel(show) {
        document.getElementById('arrivals-panel').classList.toggle('active', show);
    }
</script>
</body>
</html>

