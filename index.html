<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bus Live Cluj-Florești</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #4CAF50;
            --bg: #0a0a0a;
            --panel-bg: rgba(20, 20, 20, 0.95);
        }

        body, html { margin: 0; padding: 0; background: var(--bg); font-family: -apple-system, sans-serif; color: white; overflow: hidden; }
        
        #map { height: 100vh; width: 100vw; z-index: 1; }

        /* Panou Sosiri (Glassmorphism) */
        #arrivals-panel { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: var(--panel-bg); 
            backdrop-filter: blur(15px);
            padding: 20px; 
            border-radius: 25px 25px 0 0; 
            transform: translateY(100%); 
            transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1); 
            z-index: 1000; 
            border-top: 1px solid rgba(255,255,255,0.15);
            max-height: 65vh;
            overflow-y: auto;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.8);
        }

        #arrivals-panel.active { transform: translateY(0); }

        .handle { width: 40px; height: 4px; background: #555; border-radius: 10px; margin: -5px auto 15px; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        h2 { margin: 0; font-size: 20px; color: var(--primary); font-weight: 800; }

        .close-btn { background: #333; border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 20px; font-weight: bold; }

        /* Lista Autobuze */
        .bus-item { 
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .bus-info { display: flex; align-items: center; gap: 12px; }
        
        .bus-badge { 
            background: #e31e24; color: white; 
            min-width: 40px; height: 30px; 
            display: flex; align-items: center; justify-content: center;
            border-radius: 6px; font-weight: bold; font-size: 16px;
        }

        .bus-time { color: var(--primary); font-weight: bold; font-size: 20px; }
        .bus-unit { font-size: 12px; color: #888; margin-left: 3px; }

        .status-msg { text-align: center; padding: 30px; color: #aaa; font-size: 14px; line-height: 1.5; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="arrivals-panel">
    <div class="handle"></div>
    <div class="header">
        <div>
            <h2 id="st-name">Selectează o stație</h2>
            <div id="st-id" style="font-size: 11px; color: #777; margin-top: 2px;">Apasă pe punctele verzi</div>
        </div>
        <button class="close-btn" onclick="togglePanel(false)">&times;</button>
    </div>
    <div id="list-container"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. Inițializare Hartă pe Satelit
    const map = L.map('map', { 
        zoomControl: false, 
        attributionControl: false 
    }).setView([46.75, 23.53], 13); // Centrat între Cluj și Florești

    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}').addTo(map);

    // 2. Locația utilizatorului (Punctul Albastru)
    map.locate({watch: true, enableHighAccuracy: true});
    const userMarker = L.circleMarker([0,0], {
        radius: 7, color: '#fff', fillColor: '#007AFF', fillOpacity: 1, weight: 2
    }).addTo(map);
    map.on('locationfound', (e) => userMarker.setLatLng(e.latlng));

    // 3. Încărcare automată a stațiilor
  async function loadStations() {
        // 1. O listă scurtă de rezervă (ca să nu fie harta goală niciodată)
        const backupStations = [
            {stopId: "148", stopName: "Sora", stopLat: 46.7719, stopLon: 23.5894},
            {stopId: "143", stopName: "Memorandumului", stopLat: 46.7695, stopLon: 23.5855},
            {stopId: "512", stopName: "Florești Primărie", stopLat: 46.7454, stopLon: 23.4832},
            {stopId: "481", stopName: "Vivo (Polus)", stopLat: 46.7512, stopLon: 23.5273}
        ];

        // Afișăm stațiile de rezervă imediat
        drawStops(backupStations);

        try {
            // 2. Încercăm totuși să le luăm pe TOATE de pe server
            const res = await fetch('/api/stops');
            if (res.ok) {
                const allStops = await res.json();
                map.eachLayer((layer) => { if (layer instanceof L.CircleMarker && layer !== userMarker) map.removeLayer(layer); });
                drawStops(allStops);
            }
        } catch (err) {
            console.log("Rămânem pe stațiile de rezervă, serverul e offline.");
        }
    }

    function drawStops(stopsList) {
        stopsList.forEach(s => {
            L.circleMarker([s.stopLat, s.stopLon], {
                radius: 6, fillColor: '#4CAF50', color: '#fff', weight: 1, fillOpacity: 0.9
            })
            .addTo(map)
            .on('click', () => fetchArrivals(s));
        });
    }
    // 4. Preluare Sosiri Live
    async function fetchArrivals(s) {
        const panel = document.getElementById('arrivals-panel');
        const list = document.getElementById('list-container');
        
        document.getElementById('st-name').innerText = s.stopName;
        document.getElementById('st-id').innerText = `ID Stație: ${s.stopId}`;
        
        panel.classList.add('active');
        list.innerHTML = '<div class="status-msg">Se caută autobuze live...</div>';

        try {
            const res = await fetch(`/api/arrivals?id=${s.stopId}`);
            const data = await res.json();

            if (!res.ok || data.error) {
                list.innerHTML = `<div class="status-msg" style="color:#ff9800">⚠️ Serverul de date este momentan indisponibil (Eroare 502/404). Revenim curând!</div>`;
                return;
            }

            if (data.length === 0) {
                list.innerHTML = '<div class="status-msg">Momentan nu sunt autobuze programate să ajungă în această stație.</div>';
                return;
            }

            list.innerHTML = data.map(bus => `
                <div class="bus-item">
                    <div class="bus-info">
                        <div class="bus-badge">${bus.routeShortName}</div>
                        <div style="font-size: 14px; color: #eee;">Spre capăt de linie</div>
                    </div>
                    <div class="bus-time">
                        ${Math.round(bus.arrivalMinutes)}<span class="bus-unit">min</span>
                    </div>
                </div>
            `).join('');

        } catch (err) {
            list.innerHTML = '<div class="status-msg">Eroare de conexiune. Reîncearcă mai târziu.</div>';
        }
    }

    function togglePanel(show) {
        document.getElementById('arrivals-panel').classList.toggle('active', show);
    }

    // Pornește încărcarea
    loadStations();
</script>
</body>
</html>



