<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bus-Ctp-v2</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --primary: #4CAF50;
            --bg: #0a0a0a;
            --panel-bg: rgba(20, 20, 20, 0.95);
        }

        body, html { margin: 0; padding: 0; background: var(--bg); font-family: -apple-system, sans-serif; color: white; overflow: hidden; }
        #map { height: 100vh; width: 100vw; z-index: 1; }

        /* Buton Locația Mea */
        .locate-btn {
            position: fixed; top: 20px; right: 20px;
            width: 45px; height: 45px;
            background: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            z-index: 1001; cursor: pointer; border: none;
        }
        .locate-btn img { width: 24px; height: 24px; }

        /* Panou Sosiri */
        #arrivals-panel { 
            position: fixed; bottom: 0; left: 0; right: 0; 
            background: var(--panel-bg); backdrop-filter: blur(15px);
            padding: 20px; border-radius: 25px 25px 0 0; 
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.33, 1, 0.68, 1); 
            z-index: 1002; border-top: 1px solid rgba(255,255,255,0.15);
            max-height: 60vh; overflow-y: auto;
        }
        #arrivals-panel.active { transform: translateY(0); }

        .handle { width: 40px; height: 4px; background: #555; border-radius: 10px; margin: -5px auto 15px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h2 { margin: 0; font-size: 18px; color: var(--primary); }
        .close-btn { background: #333; border: none; color: white; width: 32px; height: 32px; border-radius: 50%; font-size: 20px; }

        .bus-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .bus-badge { background: #e31e24; color: white; min-width: 45px; height: 30px; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-weight: bold; }
        .bus-time { color: var(--primary); font-weight: bold; font-size: 20px; }
        .status-msg { text-align: center; padding: 30px; color: #aaa; }

        /* Stil pentru controlul hărților */
        .leaflet-control-layers { border-radius: 12px !important; border: none !important; box-shadow: 0 4px 15px rgba(0,0,0,0.2) !important; }
    </style>
</head>
<body>

<button class="locate-btn" onclick="goToMyLocation()" title="Locația mea">
    <img src="https://cdn-icons-png.flaticon.com/512/3593/3593254.png" alt="GPS">
</button>

<div id="map"></div>

<div id="arrivals-panel">
    <div class="handle"></div>
    <div class="header">
        <div>
            <h2 id="st-name">Selectează o stație</h2>
            <div id="st-id" style="font-size: 11px; color: #777;">Apasă pe punctele verzi</div>
        </div>
        <button class="close-btn" onclick="togglePanel(false)">&times;</button>
    </div>
    <div id="list-container"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. Definire Tipuri de Hărți
    const satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
    const streets = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
    const dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');

    const map = L.map('map', { 
        zoomControl: false, 
        attributionControl: false,
        layers: [satellite] // Implicit Satelit
    }).setView([46.77, 23.59], 13);

    // 2. Comutator Hărți
    const baseMaps = {
        "Satelit": satellite,
        "Street Map": streets,
        "Dark Mode": dark
    };
    L.control.layers(baseMaps, null, { position: 'topleft' }).addTo(map);

    // 3. Gestionare Locație Utilizator
    let userLatLng = null;
    map.locate({watch: true, enableHighAccuracy: true});

    const userMarker = L.circleMarker([0,0], {
        radius: 8, color: '#fff', fillColor: '#007AFF', fillOpacity: 1, weight: 3
    }).addTo(map);

    map.on('locationfound', (e) => {
        userLatLng = e.latlng;
        userMarker.setLatLng(e.latlng);
    });

    function goToMyLocation() {
        if (userLatLng) {
            map.flyTo(userLatLng, 16);
        } else {
            alert("Încă îți caut locația...");
        }
    }

    // 4. Încărcare Automată Stații (Toate)
    async function loadStations() {
        // Păstrăm backup-ul tău ca să nu fie harta goală în caz de eroare
        const backupStops = [
            {stopId: "148", stopName: "Sora", stopLat: 46.7719, stopLon: 23.5894},
            {stopId: "143", stopName: "Memorandumului", stopLat: 46.7695, stopLon: 23.5855},
            {stopId: "512", stopName: "Florești Primărie", stopLat: 46.7454, stopLon: 23.4832}
        ];
        drawStops(backupStops);

        try {
            const res = await fetch('/api/stops');
            if (res.ok) {
                const allStops = await res.json();
                // Curățăm harta de backup-uri înainte de a pune lista completă
                map.eachLayer((layer) => { 
                    if (layer instanceof L.CircleMarker && layer !== userMarker) map.removeLayer(layer); 
                });
                drawStops(allStops);
            }
        } catch (err) { console.log("Folosim stațiile de rezervă."); }
    }

    function drawStops(stopsList) {
        stopsList.forEach(s => {
            L.circleMarker([s.stopLat, s.stopLon], {
                radius: 6, fillColor: '#4CAF50', color: '#fff', weight: 1, fillOpacity: 0.9
            })
            .addTo(map)
            .on('click', () => fetchArrivals(s));
        });
    }

    // 5. Fetch Sosiri (Rămâne neschimbat, optimizat)
    async function fetchArrivals(s) {
        const panel = document.getElementById('arrivals-panel');
        const list = document.getElementById('list-container');
        document.getElementById('st-name').innerText = s.stopName;
        document.getElementById('st-id').innerText = `ID: ${s.stopId}`;
        
        panel.classList.add('active');
        list.innerHTML = '<div class="status-msg">Se caută autobuze...</div>';

        try {
            const res = await fetch(`/api/arrivals?id=${s.stopId}`);
            const data = await res.json();

            if (!res.ok || data.error || data.length === 0) {
                list.innerHTML = `<div class="status-msg">Momentan nu sunt date live pentru această stație.</div>`;
                return;
            }

            list.innerHTML = data.map(bus => `
                <div class="bus-item">
                    <div class="bus-info">
                        <div class="bus-badge">${bus.routeShortName}</div>
                        <div style="font-size: 13px; color: #ccc; margin-left: 10px;">Către destinație</div>
                    </div>
                    <div class="bus-time">${Math.round(bus.arrivalMinutes)} min</div>
                </div>
            `).join('');
        } catch (err) {
            list.innerHTML = '<div class="status-msg">Eroare de conexiune.</div>';
        }
    }

    function togglePanel(show) {
        document.getElementById('arrivals-panel').classList.toggle('active', show);
    }

    loadStations();
</script>
</body>
</html>



