<!DOCTYPE html>
<html lang="ro">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bus Cluj v21</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        :root { --accent: #00ff88; }
        body, html { margin: 0; padding: 0; background: #000; font-family: sans-serif; overflow: hidden; color: white; }
        #map { height: 100vh; width: 100vw; background: #000; }

        .ui-group { position: fixed; bottom: 30px; right: 20px; display: flex; flex-direction: column; gap: 12px; z-index: 1000; transition: transform 0.3s; }
        .ui-group.up { transform: translateY(-32vh); }
        .btn-action { width: 50px; height: 50px; background: #111; border: 1px solid #333; color: white; border-radius: 8px; font-weight: bold; cursor: pointer; }

        #panel {
            position: fixed; bottom: 0; left: 0; right: 0; background: #0a0a0a; border-top: 1px solid #222;
            padding: 20px; transform: translateY(100%); transition: transform 0.3s; z-index: 2000; height: 32vh; overflow-y: auto;
        }
        #panel.open { transform: translateY(0); }
        .st-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .bus-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #1a1a1a; }
        .line { color: var(--accent); font-weight: 800; font-size: 18px; }
    </style>
</head>
<body>

<div id="map"></div>

<div class="ui-group" id="controls">
    <button class="btn-action" onclick="cycleMaps()">MAP</button>
    <button class="btn-action" onclick="locateMe()">GPS</button>
</div>

<div id="panel">
    <div class="st-header">
        <div>
            <div id="p-name" style="font-weight: 800;">STAȚIE</div>
            <div id="reloader-btn" style="color: var(--accent); font-size: 12px; margin-top: 5px; cursor: pointer;">REÎNCARCĂ</div>
        </div>
        <div onclick="closePanel()" style="font-size: 30px; cursor: pointer;">×</div>
    </div>
    <div id="bus-list"></div>
</div>

<script>
    const CLOUDFLARE_PROXY = "https://tranzy-proxy.elias-samuel-rus.workers.dev/?url=";
    let currentStopId = null;

    const maps = [
        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
    ];

    let currentIdx = 0;
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([46.77, 23.59], 14);
    maps[0].addTo(map);

    // FIX GPS: Permisiunile trebuie cerute după ce utilizatorul interacționează
    function locateMe() {
        map.locate({setView: true, maxZoom: 16, enableHighAccuracy: true});
    }

    map.on('locationfound', (e) => {
        L.circleMarker(e.latlng, {radius: 8, fillColor: '#007AFF', color: '#fff', weight: 2, fillOpacity: 1}).addTo(map);
    });

    map.on('locationerror', () => alert("Activează GPS-ul din setările telefonului/browserului."));

    async function fetchRealTimes(stopId) {
        if (!stopId) return;
        const list = document.getElementById('bus-list');
        try {
            const res = await fetch(CLOUDFLARE_PROXY + encodeURIComponent(`https://api.tranzy.ai/public/v1/opendata/stops/${stopId}/arrivals`));
            const arrivals = await res.json();
            list.innerHTML = arrivals.length ? arrivals.map(bus => `
                <div class="bus-item">
                    <span class="line">${bus.routeShortName}</span>
                    <span class="eta">${Math.round(bus.arrivalIn / 60)} MIN</span>
                </div>
            `).join('') : "Fără sosiri.";
        } catch (e) { list.innerHTML = "Eroare date."; }
    }

    async function openPanel(name, latlng) {
        document.getElementById('p-name').innerText = name;
        document.getElementById('panel').classList.add('open');
        document.getElementById('controls').classList.add('up');
        document.getElementById('bus-list').innerHTML = "Căutare...";

        try {
            const res = await fetch(CLOUDFLARE_PROXY + encodeURIComponent(`https://api.tranzy.ai/public/v1/opendata/stops?lat=${latlng.lat}&lon=${latlng.lng}&dist=0.001`));
            const data = await res.json();
            if (data.length) {
                currentStopId = data[0].id;
                fetchRealTimes(currentStopId);
            } else { document.getElementById('bus-list').innerHTML = "Stație negăsită."; }
        } catch (e) { document.getElementById('bus-list').innerHTML = "Eroare conexiune."; }
    }

    function cycleMaps() {
        map.removeLayer(maps[currentIdx]);
        currentIdx = (currentIdx + 1) % maps.length;
        maps[currentIdx].addTo(map);
    }

    function closePanel() {
        document.getElementById('panel').classList.remove('open');
        document.getElementById('controls').classList.remove('up');
    }

    // Încarcă stațiile de pe hartă
    fetch("https://overpass-api.de/api/interpreter?data=[out:json];node['highway'='bus_stop'](46.70,23.40,46.85,23.70);out body;")
        .then(res => res.json()).then(data => {
            data.elements.forEach(s => {
                L.circleMarker([s.lat, s.lon], {radius: 6, fillColor: '#00ff88', color: '#fff', weight: 1, fillOpacity: 0.9})
                 .addTo(map).on('click', () => openPanel(s.tags.name || "Stație", {lat: s.lat, lng: s.lon}));
            });
        });

    document.getElementById('reloader-btn').onclick = () => fetchRealTimes(currentStopId);
</script>
</body>
</html>
